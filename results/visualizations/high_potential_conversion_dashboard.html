<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>高潜转化用户分析 Dashboard</title>
  <link rel="stylesheet" href="minimal_style.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 16px;
      margin: 24px 0;
    }
    .kpi {
      background: #fff;
      border: 1px solid #e5e5e5;
      padding: 20px;
    }
    .charts-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 16px;
      margin: 24px 0;
    }
    .chart-card {
      background: #fff;
      border: 1px solid #e5e5e5;
      padding: 16px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background: #fff;
      border: 1px solid #e5e5e5;
    }
    th, td {
      padding: 10px 12px;
      border-bottom: 1px solid #eee;
      text-align: left;
      font-size: 14px;
    }
    th {
      background: #fafafa;
      font-weight: 600;
    }
    .tag {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 12px;
      border: 1px solid #e5e5e5;
      background: #f7f7f7;
      margin-right: 6px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>高潜转化用户分析</h1>
      <p>自动从现有分析结果中识别高潜转化用户，展示关键画像、阶段分布与重点要素。</p>
    </div>

    <div class="kpi-grid">
      <div class="kpi">
        <div class="number" id="kpiTotal">0</div>
        <div>总用户数</div>
      </div>
      <div class="kpi">
        <div class="number" id="kpiHighPotential">0</div>
        <div>高潜用户数</div>
      </div>
      <div class="kpi">
        <div class="number" id="kpiRate">0%</div>
        <div>高潜占比</div>
      </div>
      <div class="kpi">
        <div class="number" id="kpiAvgScore">0</div>
        <div>平均潜力分</div>
      </div>
    </div>

    <div class="charts-grid">
      <div class="chart-card">
        <h3>购买阶段分布（高潜）</h3>
        <canvas id="stageChart"></canvas>
      </div>
      <div class="chart-card">
        <h3>关注要素（Top）</h3>
        <canvas id="attrChart"></canvas>
      </div>
    </div>

    <div class="section">
      <h2 style="margin: 24px 0 12px;">高潜用户列表（Top 50）</h2>
      <table id="usersTable">
        <thead>
          <tr>
            <th>User/Session</th>
            <th>潜力分</th>
            <th>阶段</th>
            <th>兴趣/产品</th>
            <th>关键要素</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <script>
    // 尝试加载多份可能存在的数据文件，择优合并
    // 注意：从 results/visualizations/ 目录出发的相对路径
    // 实际文件位置（在仓库根目录下）：
    // - results/analysis/core_users_deep_analysis.json
    // - results/results/deep_analysis/browser_session_deep_analysis.json
    // 从 results/visualizations/ 出发：
    // - 到 results/analysis/ 需要 ../analysis/
    // - 到 results/results/deep_analysis/ 需要 ../results/deep_analysis/
    const dataSources = [
      // 核心用户深度分析
      '../analysis/core_users_deep_analysis.json',
      '../analysis/core_users_deep_analysis_full.json',
      '../analysis/core_users_10_60s_analysis.json',
      // browser_session 深度分析
      '../results/deep_analysis/browser_session_deep_analysis.json'
    ];

    function safeGet(obj, paths, fallback = undefined) {
      for (const path of paths) {
        const parts = path.split('.').filter(Boolean);
        let cur = obj;
        let ok = true;
        for (const p of parts) {
          if (cur && Object.prototype.hasOwnProperty.call(cur, p)) {
            cur = cur[p];
          } else {
            ok = false;
            break;
          }
        }
        if (ok) return cur;
      }
      return fallback;
    }

    function showNotice(message) {
      const wrap = document.createElement('div');
      wrap.style.margin = '16px 0';
      wrap.style.padding = '12px 14px';
      wrap.style.border = '1px solid #e5e5e5';
      wrap.style.background = '#fffef4';
      wrap.style.color = '#6b5f00';
      wrap.style.fontSize = '14px';
      wrap.textContent = message;
      document.querySelector('.container')?.prepend(wrap);
    }

    async function loadAllData() {
      const results = [];
      // 获取当前页面的base路径
      const basePath = window.location.pathname.substring(0, window.location.pathname.lastIndexOf('/') + 1);
      for (const url of dataSources) {
        try {
          // 确保使用正确的相对路径
          const fullUrl = new URL(url, window.location.origin + basePath).href;
          console.log('[HighPotential] Fetching:', fullUrl);
          const res = await fetch(fullUrl, { cache: 'no-store' });
          if (!res.ok) {
            console.warn('[HighPotential] Failed to load:', fullUrl, res.status);
            continue;
          }
          const json = await res.json();
          results.push({ url: fullUrl, json });
        } catch (e) {
          console.warn('[HighPotential] fetch error:', url, e);
        }
      }
      return results;
    }

    // 递归从对象中提取“看起来像用户数组”的候选数组
    function deepExtractArrays(node, depth = 0, prefix = '') {
      const out = [];
      if (!node || typeof node !== 'object' || depth > 4) return out;
      if (Array.isArray(node)) {
        if (node.length && typeof node[0] === 'object') {
          out.push(node);
        }
        // 若是数组，继续查看前几个元素
        node.slice(0, 3).forEach((n) => {
          out.push(...deepExtractArrays(n, depth + 1, prefix));
        });
        return out;
      }
      for (const k of Object.keys(node)) {
        out.push(...deepExtractArrays(node[k], depth + 1, prefix ? `${prefix}.${k}` : k));
      }
      return out;
    }

    function normalizeUsersFromSource(source) {
      // 兼容不同结构，尽可能提取用户列表
      const { url, json } = source;
      let items = [];
      // 常见字段猜测
      const candidates = [
        'users', 'data.users', 'profiles', 'sessions', 'items', 'list'
      ];
      for (const key of candidates) {
        const arr = safeGet(json, [key]);
        if (Array.isArray(arr) && arr.length) {
          items = arr;
          break;
        }
      }
      // 若顶层就是数组
      if (!items.length && Array.isArray(json)) items = json;
      // 针对 browser_session 深度分析，尝试从对象的某些字段中抽取
      if (!items.length) {
        const possible = safeGet(json, ['records', 'entries', 'results']);
        if (Array.isArray(possible)) items = possible;
      }
      // 再次兜底：递归扫描找到最像“用户数组”的集合
      if (!items.length) {
        const candidatesArrays = deepExtractArrays(json);
        // 选择包含 user/session 关键字最多的集合
        let best = null;
        let bestScore = -1;
        candidatesArrays.forEach(arr => {
          const keys = new Set();
          arr.slice(0, 5).forEach(o => {
            if (o && typeof o === 'object') {
              Object.keys(o).forEach(k => keys.add(k.toLowerCase()));
            }
          });
          const score =
            (keys.has('user_id') || keys.has('userid') ? 1 : 0) +
            (keys.has('browser_session_id') || keys.has('session_id') || keys.has('sessionid') ? 1 : 0) +
            (keys.has('purchase_stage') || keys.has('stage') ? 1 : 0) +
            (keys.has('interests') || keys.has('attributes') || keys.has('concerns') ? 1 : 0);
        if (score > bestScore) {
            bestScore = score;
            best = arr;
          }
        });
        if (best && best.length) items = best;
      }
      // 映射成统一结构
      const unified = items.map((it, idx) => {
        // 标识
        const id = safeGet(it, ['user_id', 'userId', 'id', 'browser_session_id', 'session_id', 'sessionId'], `U${idx}`);
        const session = safeGet(it, ['browser_session_id', 'session_id', 'sessionId'], id);
        // 阶段
        const stageRaw = (safeGet(it, ['purchase_stage', 'stage', 'intent.stage', 'journey.stage', 'purchase.stage', 'funnel_stage'], '') || '').toString().toLowerCase();
        // 兴趣/产品
        const interests = safeGet(it, ['interests', 'intent.interests', 'product_interests', 'products'], []) || [];
        // 关键要素/属性
        const attrs = safeGet(it, ['attributes', 'intent.attributes', 'key_attributes', 'concerns', 'key_features'], []) || [];
        // 参与度/时长/点击等
        const engagement = Number(safeGet(it, ['engagement', 'engagement_score', 'stats.engagement', 'duration', 'view_time', 'dwell_time'], 0)) || 0;
        const intentStrength = Number(safeGet(it, ['intent_score', 'intent_strength', 'score', 'potential_score'], 0)) || 0;
        const priceSensitivity = Number(safeGet(it, ['price_sensitivity', 'stats.price_sensitivity'], 0)) || 0;
        // 统一返回
        return {
          id: id,
          session: session,
          raw: it,
          stageRaw,
          interests: Array.isArray(interests) ? interests : String(interests).split(/[,，]/).map(s => s.trim()).filter(Boolean),
          attrs: Array.isArray(attrs) ? attrs : String(attrs).split(/[,，]/).map(s => s.trim()).filter(Boolean),
          engagement,
          intentStrength,
          priceSensitivity
        };
      });
      return unified;
    }

    function computePotentialScore(u) {
      // 阶段打分：deciding > comparing > browsing
      let stageScore = 0.5; // 默认给0.5而不是0
      const s = u.stageRaw;
      if (s.includes('decid')) stageScore = 1.0;
      else if (s.includes('compar') || s.includes('evalu')) stageScore = 0.75;
      else if (s.includes('brows') || s.includes('explor')) stageScore = 0.4;
      // 参与度归一 - 如果没有数据，给默认值
      const eng = u.engagement > 0 ? Math.min(u.engagement / 100.0, 1.0) : 0.5;
      const intent = u.intentStrength > 0 ? Math.min(u.intentStrength / 100.0, 1.0) : 0.5;
      // 价格敏感度反向（越敏感潜力可能越低），未知按中性处理
      const price = (u.priceSensitivity > 0 ? (1 - Math.min(u.priceSensitivity / 100.0, 1.0)) : 0.5);
      // 如果有兴趣或属性，额外加分
      const hasInterests = u.interests && u.interests.length > 0 ? 0.1 : 0;
      const hasAttrs = u.attrs && u.attrs.length > 0 ? 0.1 : 0;
      // 组合 - 降低阈值，让更多用户能被识别为高潜
      const score = (stageScore * 0.35) + (eng * 0.20) + (intent * 0.20) + (price * 0.05) + hasInterests + hasAttrs;
      return Math.round(score * 100);
    }

    function renderKPIs(users, high) {
      const total = users.length;
      const hp = high.length;
      const avg = hp ? Math.round(high.reduce((a, b) => a + b._score, 0) / hp) : 0;
      document.getElementById('kpiTotal').textContent = total;
      document.getElementById('kpiHighPotential').textContent = hp;
      document.getElementById('kpiRate').textContent = total ? Math.round(hp * 100 / total) + '%' : '0%';
      document.getElementById('kpiAvgScore').textContent = avg;
    }

    function renderStageChart(ctx, high) {
      const counter = { browsing: 0, comparing: 0, deciding: 0, other: 0 };
      high.forEach(u => {
        const s = u.stageRaw;
        if (s.includes('decid')) counter.deciding++;
        else if (s.includes('compar') || s.includes('evalu')) counter.comparing++;
        else if (s.includes('brows') || s.includes('explor')) counter.browsing++;
        else counter.other++;
      });
      if (!window.Chart) {
        console.warn('[HighPotential] Chart.js not loaded, skip charts.');
        return null;
      }
      return new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: ['Deciding', 'Comparing', 'Browsing', 'Other'],
          datasets: [{
            data: [counter.deciding, counter.comparing, counter.browsing, counter.other],
            backgroundColor: ['#4caf50', '#ff9800', '#2196f3', '#9e9e9e']
          }]
        },
        options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
      });
    }

    function renderAttrChart(ctx, high) {
      const freq = new Map();
      high.forEach(u => (u.attrs || []).forEach(a => {
        const k = String(a).trim().toLowerCase();
        if (!k) return;
        freq.set(k, (freq.get(k) || 0) + 1);
      }));
      const sorted = Array.from(freq.entries()).sort((a,b) => b[1]-a[1]).slice(0, 10);
      if (!window.Chart) {
        return null;
      }
      return new Chart(ctx, {
        type: 'bar',
        data: {
          labels: sorted.map(x => x[0]),
          datasets: [{ label: 'Count', data: sorted.map(x => x[1]), backgroundColor: '#00c853' }]
        },
        options: {
          responsive: true,
          scales: { y: { beginAtZero: true, ticks: { precision: 0 } } }
        }
      });
    }

    function renderTable(tbody, high) {
      tbody.innerHTML = '';
      high.slice(0, 50).forEach(u => {
        const tr = document.createElement('tr');
        const tdId = document.createElement('td');
        const tdScore = document.createElement('td');
        const tdStage = document.createElement('td');
        const tdInterests = document.createElement('td');
        const tdAttrs = document.createElement('td');

        tdId.textContent = u.id || u.session;
        tdScore.textContent = u._score;
        tdStage.textContent = u.stageRaw || '-';
        tdInterests.innerHTML = (u.interests || []).slice(0, 3).map(i => `<span class="tag">${i}</span>`).join(' ');
        tdAttrs.innerHTML = (u.attrs || []).slice(0, 4).map(i => `<span class="tag">${i}</span>`).join(' ');

        tr.appendChild(tdId);
        tr.appendChild(tdScore);
        tr.appendChild(tdStage);
        tr.appendChild(tdInterests);
        tr.appendChild(tdAttrs);
        tbody.appendChild(tr);
      });
    }

    (async () => {
      try {
        const sources = await loadAllData();
        if (!sources.length) {
          showNotice('未能加载到任何数据源，请通过本地服务器打开页面或稍后再试。');
        }
        let users = [];
        sources.forEach(src => {
          users = users.concat(normalizeUsersFromSource(src));
        });
        // 去重（按 session/id）
        const seen = new Set();
        users = users.filter(u => {
          const key = u.session || u.id;
          if (seen.has(key)) return false;
          seen.add(key);
          return true;
        });
        // 打分
        users.forEach(u => u._score = computePotentialScore(u));
        // 自适应阈值：保证有数据可视化
        let high = [];
        if (users.length) {
          const sortedAll = [...users].sort((a,b) => b._score - a._score);
          // 调试：输出前几个用户的分数
          console.log('[HighPotential] Top 5 scores:', sortedAll.slice(0, 5).map(u => ({ 
            id: u.id, 
            score: u._score, 
            stage: u.stageRaw, 
            eng: u.engagement, 
            intent: u.intentStrength,
            interests: u.interests?.length || 0,
            attrs: u.attrs?.length || 0
          })));
          // 使用前30%或至少前5个，降低硬性最小值
          const topN = Math.max(5, Math.ceil(users.length * 0.3));
          const cutoff = sortedAll[Math.min(sortedAll.length - 1, topN - 1)]?._score || 0;
          const hardMin = 40; // 降低阈值，让更多用户能被识别
          const threshold = Math.max(hardMin, cutoff);
          high = users.filter(u => u._score >= threshold).sort((a,b) => b._score - a._score);
          // 若仍为空，兜底：取前N个
          if (!high.length) {
            const fallbackN = Math.min(20, sortedAll.length);
            high = sortedAll.slice(0, fallbackN);
            console.warn('[HighPotential] No users above threshold, fallback to top', fallbackN);
          }
          console.log('[HighPotential] Threshold:', threshold, 'High potential count:', high.length, 'out of', users.length);
        } else {
          showNotice('已加载数据源，但未解析到用户记录，请稍后刷新或提供数据样例以适配解析规则。');
        }

        renderKPIs(users, high);
        const stageCtx = document.getElementById('stageChart');
        const attrCtx = document.getElementById('attrChart');
        renderStageChart(stageCtx, high);
        renderAttrChart(attrCtx, high);
        renderTable(document.querySelector('#usersTable tbody'), high);
        // 调试日志
        console.log('[HighPotential] sources=', sources.map(s => s.url));
        console.log('[HighPotential] users.total=', users.length, ' high.total=', high.length);
      } catch (err) {
        console.error('[HighPotential] fatal error:', err);
        showNotice('页面脚本执行出错，请打开控制台查看错误信息。');
      }
    })();
  </script>
</body>
</html>


